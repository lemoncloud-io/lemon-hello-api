"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};module.exports=function(n){var i={},u=y("util"),f=n._;if(!f)throw new Error("$_ is required!");i.name=u+"-utils",i.ts=l,i.dt=m,i.now=m,i.escape=function(e,r){if(void 0===e)return"NULL";if(t=e,"number"==typeof t&&t%1==0)return e;var t;"object"==(void 0===(e=e||"")?"undefined":_typeof(e))&&(e=JSON.stringify(e));e=e.replace(/\\/g,"\\\\").replace(/\$/g,"\\$").replace(/'/g,"\\'").replace(/"/g,'\\"'),r&&(e=decodeURI(e));return"'"+e+"'"},i.cleanup=function(e){return Object.keys(e).reduce(function(e,r){return r.startsWith("_")&&delete e[r],r.startsWith("$")&&delete e[r],e},e)},i.updated=function(t,n){return Object.keys(n).reduce(function(e,r){if(t[r]!==n[r]){if(null===t[r]&&""===n[r])return e;e[r]=n[r]}return e},{})},i.copy=function(t){return Object.keys(t).reduce(function(e,r){return e[r]=t[r],e},{})},i.N=_,i.F=v,i.current_time_ms=function(){var e=(new Date).getTime();return e+=0},i.NS=y,i.env=r,i.extend=d,i.isset=function(e){return void 0!==e},i.empty=function(e){return!e},i.min=function(e,r){return e<r?e:r},i.max=function(e,r){return r<e?e:r},i.round=function(e){return Math.round(e)},i.json=p,i.diff=function(n,i){return Object.keys(n).reduce(function(e,r){if(i.hasOwnProperty(r)){if(f.isEqual(n[r],i[r])){var t=e.indexOf(r);e.splice(t,1)}}else e.push(r);return e},Object.keys(i))},i.copy_node=function(t,n){return n=void 0!==n&&n,Object.keys(t).reduce(function(e,r){return r.startsWith("_")||r.startsWith("$")||(e[r]=n?null:t[r]),e},{})},i.bare_node=function(e,r){var t={};t._id=e._id,t._current_time=e._current_time,r&&(t=d(t,r));return t},i.diff_node=function(n,i){var r=[],t=[];return Object.keys(n).forEach(function(e){e.startsWith("_")||e.startsWith("$")||r.push(e)}),Object.keys(i).forEach(function(e){e.startsWith("_")||e.startsWith("$")||t.push(e)}),r.reduce(function(e,r){if(i.hasOwnProperty(r)){if(f.isEqual(n[r],i[r])){var t=e.indexOf(r);e.splice(t,1)}}else e.push(r);return e},t)},i.hash=function(e){return function(e,r,t){var n,i=void 0,o=void 0===t?2166136261:t;for(i=0,n=e.length;i<n;i++)o^=e.charCodeAt(i),o+=(o<<1)+(o<<4)+(o<<7)+(o<<8)+(o<<24);return r?("0000000"+(o>>>0).toString(16)).substr(-8):o>>>0}(e="string"!=typeof(e="object"===(void 0===(e=e||"")?"undefined":_typeof(e))?p(e,!0):e)?String(e):e)},i.md5=function(e,r){var t=require("crypto");return r=void 0===r?"hex":r,t.createHash("md5").update(e).digest(r)},i.hmac=function(e,r,t,n){var i=require("crypto");return r=r||"XENI",n=n||"base64",t=t||"sha256",i.createHmac(t,r).update(e).digest(n)},i.logger_factory=t,i.load_data_csv=function(e){if(!e)throw new Error("param:name is required!");var r=require("fs"),i=require("csv-parse"),o=require("path").resolve(__dirname,"../data/"+e+(e.endsWith(".csv")?"":".csv"));return new Promise(function(t,n){r.readFile(o,"UTF-8",function(e,r){if(e)return n(e);i(r,{columns:!0,trim:!0},function(e,r){return e?n(e):t(r)})})})},i.load_data_yml=function(e){if(!e)throw new Error("param:name is required!");var t=require("fs"),r=require("path"),n=require("js-yaml"),i=r.resolve(__dirname,"../data/"+e+(e.endsWith(".yml")?"":".yml"));return o(u,"load file =",i),new Promise(function(e,r){try{e(n.safeLoad(t.readFileSync(i,"utf8")))}catch(e){r(e)}})},i.promise=h,i.promise_sequence=function(e,t){var r=h(e.shift());return r=e.reduce(function(e,r){return e.then(function(){return t(r)})},r.then(function(e){return t(e)}))},i.trans_row_to_prod_node=function(e){if(!e)return null;if(Array.isArray(e))throw new Error("row is array.");return b().transform_row(e)},i.trans_prod_node_to_row=function(e){if(!e)return null;if("object"!=(void 0===e?"undefined":_typeof(e)))throw new Error("node must be object. but is "+(void 0===e?"undefined":_typeof(e)));return b().transform_node(e)},i.split_prod_node_to_aid=function(e,r,t,n){if(!e)return null;if("object"!=(void 0===e?"undefined":_typeof(e)))throw new Error("node must be object. but is "+(void 0===e?"undefined":_typeof(e)));if("object"!=(void 0===r?"undefined":_typeof(r)))throw new Error("atem must be object. but is "+(void 0===r?"undefined":_typeof(r)));if("object"!=(void 0===t?"undefined":_typeof(t)))throw new Error("item must be object. but is "+(void 0===t?"undefined":_typeof(t)));if("object"!=(void 0===n?"undefined":_typeof(n)))throw new Error("deal must be object. but is "+(void 0===n?"undefined":_typeof(n)));return b().split_node(e,r,t,n)},i.merge_prod_node_by_aid=function(e,r,t,n){if(!e)return null;if("object"!=(void 0===e?"undefined":_typeof(e)))throw new Error("node must be object. but is "+(void 0===e?"undefined":_typeof(e)));if("object"!=(void 0===r?"undefined":_typeof(r)))throw new Error("atem must be object. but is "+(void 0===r?"undefined":_typeof(r)));if("object"!=(void 0===t?"undefined":_typeof(t)))throw new Error("item must be object. but is "+(void 0===t?"undefined":_typeof(t)));if("object"!=(void 0===n?"undefined":_typeof(n)))throw new Error("deal must be object. but is "+(void 0===n?"undefined":_typeof(n)));return b().merge_node(e,r,t,n)};var o=o||n.log||function(){return c(arguments,"I")},s=s||n.err||function(){return c(arguments,"E")},e=e||function(){var e=r("ENV")||r("NODE_ENV")||r("STAGE");return"production"!==e&&"op"!==e};function r(e,r){if("function"==typeof n.get_env)return n.get_env(e,r);if("function"==typeof n.environ)return n.environ(e,r);var t=process&&process.env[e]||void 0;return void 0===t?r:t}function t(){return{create:function(e,r){e=e||u,r=r||"/var/www/html/logs/";var t=require("log4js"),n=r+e+".log";return t.loadAppender("file"),t.addAppender(t.appenders.file(n),e),t.getLogger(e)}}}i.log=o,i.err=s,i.is_dev=e();var a=null,c=function(e,r){return a?"E"==r?a.error.apply(a,e):a.info.apply(a,e):"undefined"!=typeof console&&(Array.isArray(e)||(e=Array.prototype.slice.call(e)),r&&e.unshift(r),e.unshift(l()),"E"==r?console.error.apply(console,e):console.log.apply(console,e)),!0};function d(e,r){for(var t in r)e[t]=r[t];return e}function p(r,e){if(e){var t={};Object.keys(r).sort().forEach(function(e){t[e]=r[e]}),r=t}return r&&JSON.stringify(r)||r}function l(e){var r=e&&"object"===(void 0===e?"undefined":_typeof(e))?e:e?new Date(e):new Date,t=r.getFullYear(),n=r.getMonth()+1,i=(e=r.getDate(),r.getHours()),o=r.getMinutes(),u=r.getSeconds();return(t<10?"0":"")+t+"-"+(n<10?"0":"")+n+"-"+(e<10?"0":"")+e+" "+(i<10?"0":"")+i+":"+(o<10?"0":"")+o+":"+(u<10?"0":"")+u}function m(e){var r=(e=e||l()).split(" "),t=r[0].split("-"),n=r[1].split(":"),i=parseInt(t[0]),o=parseInt(t[1])-1,u=parseInt(t[2]),a=parseInt(n[0]),f=parseInt(n[1]),s=parseInt(n[2]);return Date.prototype.add_seconds||(Date.prototype.add_seconds=function(e){return this.setSeconds(this.getSeconds()+e),this}),Date.prototype.ts||(Date.prototype.ts=function(){return l(this)}),new Date(i,o,u,a,f,s,0)}function y(e,r,t){if(!e)return e;t=t||4,t-=e.length;if(e="           ".substr(0,t=t<0?0:t)+e+":",i.is_dev&&r){e={red:"[31m",green:"[32m",yellow:"[33m",blue:"[34m",magenta:"[35m",cyan:"[36m",white:"[37m"}[r]+e+"[0m"}return e}function _(r,t){try{return""===r||null==r?t:"number"==typeof r&&r%1==0?r:"number"==typeof r?parseInt(r):(r=(r="0"+r).startsWith("0-")?r.substr(1):r,parseInt(r.replace(/,/gi,"").trim()))}catch(e){return s("err at _N: x="+r+";"+(void 0===r?"undefined":_typeof(r))+";"+(e.message||""),e),t}}function v(r,t){try{return""===r||null==r?t:"number"==typeof r&&r%1==0?r:"number"==typeof r?parseFloat(r):(r=(r="0"+r).startsWith("0-")?r.substr(1):r,parseFloat(r.replace(/,/gi,"").trim()))}catch(e){return s("err at _N: x="+r+";"+(void 0===r?"undefined":_typeof(r))+";"+(e.message||""),e),t}}function h(t){return new Promise(function(e,r){e(t)})}function b(){var e="_trans_handler_prod",a=i[e];return a||(o(u,"build transformer of prod!"),(a={initialize:function(){var e=function(r){if(!r)throw new Error("param:name is required!");var e=require("fs"),t=require("path"),n=require("js-yaml"),i=t.resolve(__dirname,"../data/"+r+(r.endsWith(".yml")?"":".yml"));try{return o(u,"load-sync-file =",i),n.safeLoad(e.readFileSync(i,"utf8"))}catch(e){s(u,"error:load-sync-yaml("+r+")=",e)}return{}}("prod-fields"),r=e&&e.fields;if(!r)throw new Error(u+"valid fields definition is required!");var t={parser:{},serial:{},splits:{}};t=f.reduce(r,function(e,r,o){var t=function(e,r){if("object"===(void 0===r?"undefined":_typeof(r)))e=f.reduce(r,function(e,t,r){if("X"==r){var n={atem:null,item:null,deal:null};if(t)(Array.isArray(t)?t:t.split(",")).forEach(function(e){if((e=e.trim()).startsWith("."))n.atem=e.substring(1),n.item=e.substring(1),n.deal=e.substring(1);else if(e.endsWith("."))n[e.substring(0,e.length-1)]=o;else if(e.indexOf(".")){var r=e.split(".",2);n[r[0]]=r[1]}else s(u,"WARN!! NO ALIAS SUPPORT name:"+t)});return e.splits[o]=n,e}var i=a.parser[r];return i||s(u,"ERROR! invalid type:"+r+", name:"+t),t&&i&&(e.parser[t]={name:o,trans:i},e.serial[o]||(e.serial[o]={name:t,trans:a.serial[r]})),e},e);else{var t=a.parser.S;e.parser[r]={name:o,trans:t},e.serial[o]||(e.serial[o]={name:r,trans:a.serial.S})}return e};return e=Array.isArray(r)?f.reduce(r,function(e,r){return e=t(e,r)},e):t(e,r)},t),a._map=t},transform_row:function(e){var r={};return r=f.reduce(e,function(e,r,t){var n=a._map.parser[t];return n||s(u,"ERROR! invalid parser by key:"+t),n&&(e[n.name]=n.trans(r)),e},r)},transform_node:function(e){var r={};return r=f.reduce(e,function(e,r,t){var n=a._map.serial[t];return n||s(u,"ERROR! invalid serial by name:"+t),n&&(e[n.name]=n.trans(r)),e},r)},split_node:function(e,i,o,u){var r={};return r=f.reduce(e,function(e,r,t){if(t.startsWith("_")||t.startsWith("$"))return e;var n=a._map.splits[t];return n?(n.atem&&(i[n.atem]=r),n.item&&(o[n.item]=r),n.deal&&(u[n.deal]=r)):i[t]=r,e},r)},merge_node:function(e,i,o,u){i=i||{},o=o||{},u=u||{};var r={};return d(e,r=f.reduce(e,function(e,r,t){if(t.startsWith("_")||t.startsWith("$"))return e;var n=a._map.splits[t];return n?(n.item&&(e[t]=o[n.item]),n.atem&&(e[t]=i[n.atem]),n.deal&&(e[t]=u[n.deal])):void 0!==i[t]&&(e[t]=i[t]),e},r)),r},parser:{I:function(e){return parseInt(_(e,0))},N:function(e){return _(e,0)},F:function(e){return v(e,0)},F1:function(e){return Math.round(10*v(e,0))/10},F2:function(e){return Math.round(100*v(e,0))/100},F3:function(e){return Math.round(1e3*v(e,0))/1e3},U:function(e){throw new Error("not implemented!")},O:function(e){throw new Error("not implemented!")},A:function(e){return e?(e||"").split(","):[]},AI:function(e){return e?(e||"").split(",").map(function(e){return _(e,0)}):[]},AN:function(e){return e?(e||"").split(",").map(function(e){return _(e,0)}):[]},M:function(e){return JSON.parse(e)},S:function(e){return"string"==typeof e?e.trim():""+e},B:function(e){return"Y"===(e=(e||"").toUpperCase())||"T"===e||"1"===e||"true"===e}},serial:{I:function(e){return e},N:function(e){return e},F:function(e){return e},F1:function(e){return _(Math.round(10*e))/10},F2:function(e){return _(Math.round(100*e))/100},F3:function(e){return _(Math.round(1e3*e))/1e3},U:function(e){throw new Error("not implemented!")},O:function(e){throw new Error("not implemented!")},A:function(e){return(e||[]).join(",")},AI:function(e){return(e||[]).join(",")},AN:function(e){return(e||[]).join(",")},M:function(e){return p(e)},S:function(e){return""+e},B:function(e){return e?"Y":"N"}}}).initialize(),i[e]=a)}return i};